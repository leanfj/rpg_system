// Prisma Schema para RPG Session Support
// https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "sqlite"
  url      = "file:./rpg_sessions.db"
}

// ==========================================
// MODELOS
// ==========================================

/// Campanha de RPG (ex: "A Maldição de Strahd", "Homebrew Medieval")
model Campaign {
  id        String    @id @default(cuid())
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  // Relacionamentos
  sessions  Session[]
  npcs      Npc[]
  quests    Quest[]
  locations Location[]
  storyEvents StoryEvent[]
  masterNotes MasterNote[]
  turnMonitor TurnMonitor?
  playerCharacters PlayerCharacter[]
  
  @@map("campaigns")
}

/// Monitoramento de turnos por campanha
model TurnMonitor {
  id         String   @id @default(cuid())
  campaignId String
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId])
  @@map("turn_monitors")
}

/// Anotacoes do mestre por campanha
model MasterNote {
  id         String   @id @default(cuid())
  campaignId String
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId])
  @@map("master_notes")
}

/// Quest/objetivo de uma campanha
model Quest {
  id         String   @id @default(cuid())
  campaignId String
  title      String
  status     String
  objective String?
  reward    String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sessionNotes SessionNoteQuest[]

  @@index([campaignId])
  @@map("quests")
}

/// Local de uma campanha
model Location {
  id          String   @id @default(cuid())
  campaignId  String
  name        String
  description String?
  status      String   @default("unknown") // unknown, safe, dangerous
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sessionNotes SessionNoteLocation[]
  
  @@index([campaignId])
  @@map("locations")
}

/// Evento narrativo de uma campanha
model StoryEvent {
  id          String   @id @default(cuid())
  campaignId  String
  title       String
  description String?
  status      String   @default("active") // active, resolved, ignored
  impact      String?  // short, medium, long
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sessionNotes SessionNoteEvent[]
  
  @@index([campaignId])
  @@map("story_events")
}

/// Sessão de jogo - uma "partida" dentro de uma campanha
model Session {
  id         String    @id @default(cuid())
  campaignId String
  startedAt  DateTime  @default(now())
  endedAt    DateTime?
  
  // Metadados
  title      String?   // Título opcional (ex: "Sessão 15 - A Torre do Mago")
  notes      String?   // Anotações manuais do mestre
  status     String    @default("planned") // planned, in_progress, finished
  
  // Relacionamentos
  campaign    Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  transcripts TranscriptChunk[]
  events      Event[]
  sessionNotes SessionNote[]
  
  @@map("sessions")
}

/// Pedaço de transcrição (texto reconhecido pelo Whisper)
model TranscriptChunk {
  id         String   @id @default(cuid())
  sessionId  String
  text       String
  timestamp  Int      // Milissegundos desde o início da sessão
  confidence Float?   // Confiança do reconhecimento (0-1)
  createdAt  DateTime @default(now())
  
  // Relacionamentos
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([timestamp])
  @@map("transcript_chunks")
}

/// Evento detectado durante a sessão (combate, rolagem crítica, etc)
model Event {
  id        String   @id @default(cuid())
  sessionId String
  type      String   // Tipo do evento: "combat_start", "critical_hit", "npc_mention", etc
  payload   String   // JSON com dados específicos do evento
  timestamp Int      // Milissegundos desde o início da sessão
  createdAt DateTime @default(now())
  
  // Relacionamentos
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([type])
  @@map("events")
}

/// NPC (Personagem Não-Jogador) de uma campanha
model Npc {
  id          String   @id @default(cuid())
  campaignId  String
  name        String
  race        String?
  occupation  String?
  location    String?
  tags        String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamentos
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sessionNotes SessionNoteNpc[]
  
  @@index([campaignId])
  @@map("npcs")
}

/// Personagem jogador (D&D 5e 2024)
model PlayerCharacter {
  id         String   @id @default(cuid())
  campaignId String
  name       String
  playerName String?
  className  String
  subclass   String?
  level      Int
  ancestry   String
  background String?
  alignment  String?
  experience Int?
  inspiration Boolean?
  proficiencyBonus Int?
  armorClass Int
  initiative Int?
  speed      Int?
  hitPoints  Int
  currentHitPoints Int?
  tempHitPoints Int?
  hitDice    String?
  deathSaves String?
  passivePerception Int?
  strength   Int
  dexterity  Int
  constitution Int
  intelligence Int
  wisdom     Int
  charisma   Int
  savingThrows String?
  proficiencies String?
  skills     String?
  attacks    String?
  spells     String?
  equipment  String?
  features   String?
  personalityTraits String?
  ideals     String?
  bonds      String?
  flaws      String?
  notes      String?
  sheetUrl   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sessionNotes SessionNotePlayer[]

  @@index([campaignId])
  @@map("player_characters")
}

/// Nota de sessão (Antes, Durante ou Após sessão)
model SessionNote {
  id         String   @id @default(cuid())
  sessionId  String
  phase      String   // before, during, after
  content    String
  importance String   @default("normal") // normal, high
  order      Int      @default(0) // Ordem dentro da fase
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relacionamentos
  session  Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  npcs     SessionNoteNpc[]
  players  SessionNotePlayer[]
  quests   SessionNoteQuest[]
  locations SessionNoteLocation[]
  events   SessionNoteEvent[]

  @@index([sessionId])
  @@index([phase])
  @@map("session_notes")
}

/// Conexão entre SessionNote e NPC
model SessionNoteNpc {
  id            String      @id @default(cuid())
  sessionNoteId String
  npcId         String
  createdAt     DateTime    @default(now())

  sessionNote SessionNote @relation(fields: [sessionNoteId], references: [id], onDelete: Cascade)
  npc         Npc         @relation(fields: [npcId], references: [id], onDelete: Cascade)

  @@unique([sessionNoteId, npcId])
  @@index([sessionNoteId])
  @@index([npcId])
  @@map("session_note_npcs")
}

/// Conexão entre SessionNote e PlayerCharacter
model SessionNotePlayer {
  id            String          @id @default(cuid())
  sessionNoteId String
  playerId      String
  createdAt     DateTime        @default(now())

  sessionNote SessionNote     @relation(fields: [sessionNoteId], references: [id], onDelete: Cascade)
  player      PlayerCharacter @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([sessionNoteId, playerId])
  @@index([sessionNoteId])
  @@index([playerId])
  @@map("session_note_players")
}

/// Conexão entre SessionNote e Quest
model SessionNoteQuest {
  id            String      @id @default(cuid())
  sessionNoteId String
  questId       String
  createdAt     DateTime    @default(now())

  sessionNote SessionNote @relation(fields: [sessionNoteId], references: [id], onDelete: Cascade)
  quest       Quest       @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@unique([sessionNoteId, questId])
  @@index([sessionNoteId])
  @@index([questId])
  @@map("session_note_quests")
}

/// Conexão entre SessionNote e Location
model SessionNoteLocation {
  id            String      @id @default(cuid())
  sessionNoteId String
  locationId    String
  createdAt     DateTime    @default(now())

  sessionNote SessionNote @relation(fields: [sessionNoteId], references: [id], onDelete: Cascade)
  location    Location    @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([sessionNoteId, locationId])
  @@index([sessionNoteId])
  @@index([locationId])
  @@map("session_note_locations")
}

/// Conexão entre SessionNote e StoryEvent
model SessionNoteEvent {
  id            String      @id @default(cuid())
  sessionNoteId String
  eventId       String
  createdAt     DateTime    @default(now())

  sessionNote SessionNote @relation(fields: [sessionNoteId], references: [id], onDelete: Cascade)
  event       StoryEvent  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([sessionNoteId, eventId])
  @@index([sessionNoteId])
  @@index([eventId])
  @@map("session_note_events")
}
